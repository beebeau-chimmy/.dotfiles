"use strict";
"use babel";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.fetchAllUrls = fetchAllUrls;
exports.fetchAndReplaceText = fetchAndReplaceText;
exports.getUrls = getUrls;
exports.replace = replace;
async function fetchAndReplaceText(text) {
  const words = text.split(/\s+/);
  if (words.length == 0) {
    return text;
  }

  // get urls
  const urls = getUrls(words);

  // fetch and get titles
  const urlMap = await getUrlAndTitleMap(urls);

  // replace
  urls.map(url => {
    if (!urlMap.has(url)) {
      return;
    }
    const value = urlMap.get(url);
    text = replace(text, url, value);
  });
  return text;
}
function getUrls(words) {
  const urls = new Array();
  const urlMap = new Map();
  for (let i = 0; i < words.length; i++) {
    const url = words[i];
    // check url
    if (url.substr(0, 8) !== "https://" && url.substr(0, 7) !== "http://") {
      continue;
    }
    if (urlMap.has(url)) {
      continue;
    }
    urlMap.set(url, "");
    urls.push(url);
  }
  urls.sort((a, b) => {
    return b.length - a.length;
  });
  return urls;
}
function fetchAllUrls(urls) {
  return Promise.allSettled(urls.map(url => {
    return fetch(url).then(res => {
      if (!res.ok) {
        return Promise.reject(`url:${url}, Status Code:${res.status}`);
      }
      return Promise.resolve(res.text());
    }).then(text => {
      const newdom = new DOMParser().parseFromString(text, "text/html");
      const title = newdom.head.getElementsByTagName("title")[0].text;
      return Promise.resolve({
        url: url,
        text: `[${title}](${url})`
      });
    });
  }));
}
async function getUrlAndTitleMap(urls) {
  const urlMap = new Map();
  await fetchAllUrls(urls).then(results => {
    results.forEach(result => {
      if (result.status == "fulfilled") {
        urlMap.set(result.value.url, result.value.text);
      } else if (result.status == "rejected") {
        console.error("Error:", result.reason);
      }
    });
  });
  return urlMap;
}
function replace(text, target, replaceText) {
  const index = text.indexOf(target);
  const nextStart = index + target.length;
  if (index < 0 || nextStart > text.length) {
    return text;
  }
  if (index > 2 && text.substr(index - 2, 2) == "](" && text.length > nextStart && text[nextStart] == ")") {
    return text.substr(0, nextStart) + replace(text.substr(nextStart), target, replaceText);
  }
  return text.substr(0, index) + replaceText + replace(text.substr(nextStart), target, replaceText);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJ2YWx1ZSIsImZldGNoQWxsVXJscyIsImZldGNoQW5kUmVwbGFjZVRleHQiLCJnZXRVcmxzIiwicmVwbGFjZSIsInRleHQiLCJ3b3JkcyIsInNwbGl0IiwibGVuZ3RoIiwidXJscyIsInVybE1hcCIsImdldFVybEFuZFRpdGxlTWFwIiwibWFwIiwidXJsIiwiaGFzIiwiZ2V0IiwiQXJyYXkiLCJNYXAiLCJpIiwic3Vic3RyIiwic2V0IiwicHVzaCIsInNvcnQiLCJhIiwiYiIsIlByb21pc2UiLCJhbGxTZXR0bGVkIiwiZmV0Y2giLCJ0aGVuIiwicmVzIiwib2siLCJyZWplY3QiLCJzdGF0dXMiLCJyZXNvbHZlIiwibmV3ZG9tIiwiRE9NUGFyc2VyIiwicGFyc2VGcm9tU3RyaW5nIiwidGl0bGUiLCJoZWFkIiwiZ2V0RWxlbWVudHNCeVRhZ05hbWUiLCJyZXN1bHRzIiwiZm9yRWFjaCIsInJlc3VsdCIsImNvbnNvbGUiLCJlcnJvciIsInJlYXNvbiIsInRhcmdldCIsInJlcGxhY2VUZXh0IiwiaW5kZXgiLCJpbmRleE9mIiwibmV4dFN0YXJ0Il0sInNvdXJjZXMiOlsibGluay1mb3JtYXQtcmVwbGFjZS5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBiYWJlbFwiO1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZmV0Y2hBbmRSZXBsYWNlVGV4dCh0ZXh0KSB7XG4gIGNvbnN0IHdvcmRzID0gdGV4dC5zcGxpdCgvXFxzKy8pO1xuICBpZiAod29yZHMubGVuZ3RoID09IDApIHtcbiAgICByZXR1cm4gdGV4dDtcbiAgfVxuXG4gIC8vIGdldCB1cmxzXG4gIGNvbnN0IHVybHMgPSBnZXRVcmxzKHdvcmRzKTtcblxuICAvLyBmZXRjaCBhbmQgZ2V0IHRpdGxlc1xuICBjb25zdCB1cmxNYXAgPSBhd2FpdCBnZXRVcmxBbmRUaXRsZU1hcCh1cmxzKTtcblxuICAvLyByZXBsYWNlXG4gIHVybHMubWFwKCh1cmwpID0+IHtcbiAgICBpZiAoIXVybE1hcC5oYXModXJsKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCB2YWx1ZSA9IHVybE1hcC5nZXQodXJsKTtcbiAgICB0ZXh0ID0gcmVwbGFjZSh0ZXh0LCB1cmwsIHZhbHVlKTtcbiAgfSk7XG5cbiAgcmV0dXJuIHRleHQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRVcmxzKHdvcmRzKSB7XG4gIGNvbnN0IHVybHMgPSBuZXcgQXJyYXkoKTtcbiAgY29uc3QgdXJsTWFwID0gbmV3IE1hcCgpO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IHdvcmRzLmxlbmd0aDsgaSsrKSB7XG4gICAgY29uc3QgdXJsID0gd29yZHNbaV07XG4gICAgLy8gY2hlY2sgdXJsXG4gICAgaWYgKHVybC5zdWJzdHIoMCwgOCkgIT09IFwiaHR0cHM6Ly9cIiAmJiB1cmwuc3Vic3RyKDAsIDcpICE9PSBcImh0dHA6Ly9cIikge1xuICAgICAgY29udGludWU7XG4gICAgfVxuXG4gICAgaWYgKHVybE1hcC5oYXModXJsKSkge1xuICAgICAgY29udGludWU7XG4gICAgfVxuXG4gICAgdXJsTWFwLnNldCh1cmwsIFwiXCIpO1xuICAgIHVybHMucHVzaCh1cmwpO1xuICB9XG4gIHVybHMuc29ydCgoYSwgYikgPT4ge1xuICAgIHJldHVybiBiLmxlbmd0aCAtIGEubGVuZ3RoO1xuICB9KTtcblxuICByZXR1cm4gdXJscztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZldGNoQWxsVXJscyh1cmxzKSB7XG4gIHJldHVybiBQcm9taXNlLmFsbFNldHRsZWQoXG4gICAgdXJscy5tYXAoKHVybCkgPT4ge1xuICAgICAgcmV0dXJuIGZldGNoKHVybClcbiAgICAgICAgLnRoZW4oKHJlcykgPT4ge1xuICAgICAgICAgIGlmICghcmVzLm9rKSB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoYHVybDoke3VybH0sIFN0YXR1cyBDb2RlOiR7cmVzLnN0YXR1c31gKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShyZXMudGV4dCgpKTtcbiAgICAgICAgfSlcbiAgICAgICAgLnRoZW4oKHRleHQpID0+IHtcbiAgICAgICAgICBjb25zdCBuZXdkb20gPSBuZXcgRE9NUGFyc2VyKCkucGFyc2VGcm9tU3RyaW5nKHRleHQsIFwidGV4dC9odG1sXCIpO1xuICAgICAgICAgIGNvbnN0IHRpdGxlID0gbmV3ZG9tLmhlYWQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJ0aXRsZVwiKVswXS50ZXh0O1xuICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyB1cmw6IHVybCwgdGV4dDogYFske3RpdGxlfV0oJHt1cmx9KWAgfSk7XG4gICAgICAgIH0pO1xuICAgIH0pXG4gICk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFVybEFuZFRpdGxlTWFwKHVybHMpIHtcbiAgY29uc3QgdXJsTWFwID0gbmV3IE1hcCgpO1xuICBhd2FpdCBmZXRjaEFsbFVybHModXJscykudGhlbigocmVzdWx0cykgPT4ge1xuICAgIHJlc3VsdHMuZm9yRWFjaCgocmVzdWx0KSA9PiB7XG4gICAgICBpZiAocmVzdWx0LnN0YXR1cyA9PSBcImZ1bGZpbGxlZFwiKSB7XG4gICAgICAgIHVybE1hcC5zZXQocmVzdWx0LnZhbHVlLnVybCwgcmVzdWx0LnZhbHVlLnRleHQpO1xuICAgICAgfSBlbHNlIGlmIChyZXN1bHQuc3RhdHVzID09IFwicmVqZWN0ZWRcIikge1xuICAgICAgICBjb25zb2xlLmVycm9yKFwiRXJyb3I6XCIsIHJlc3VsdC5yZWFzb24pO1xuICAgICAgfVxuICAgIH0pO1xuICB9KTtcblxuICByZXR1cm4gdXJsTWFwO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVwbGFjZSh0ZXh0LCB0YXJnZXQsIHJlcGxhY2VUZXh0KSB7XG4gIGNvbnN0IGluZGV4ID0gdGV4dC5pbmRleE9mKHRhcmdldCk7XG4gIGNvbnN0IG5leHRTdGFydCA9IGluZGV4ICsgdGFyZ2V0Lmxlbmd0aDtcbiAgaWYgKGluZGV4IDwgMCB8fCBuZXh0U3RhcnQgPiB0ZXh0Lmxlbmd0aCkge1xuICAgIHJldHVybiB0ZXh0O1xuICB9XG5cbiAgaWYgKFxuICAgIGluZGV4ID4gMiAmJlxuICAgIHRleHQuc3Vic3RyKGluZGV4IC0gMiwgMikgPT0gXCJdKFwiICYmXG4gICAgdGV4dC5sZW5ndGggPiBuZXh0U3RhcnQgJiZcbiAgICB0ZXh0W25leHRTdGFydF0gPT0gXCIpXCJcbiAgKSB7XG4gICAgcmV0dXJuIChcbiAgICAgIHRleHQuc3Vic3RyKDAsIG5leHRTdGFydCkgK1xuICAgICAgcmVwbGFjZSh0ZXh0LnN1YnN0cihuZXh0U3RhcnQpLCB0YXJnZXQsIHJlcGxhY2VUZXh0KVxuICAgICk7XG4gIH1cblxuICByZXR1cm4gKFxuICAgIHRleHQuc3Vic3RyKDAsIGluZGV4KSArXG4gICAgcmVwbGFjZVRleHQgK1xuICAgIHJlcGxhY2UodGV4dC5zdWJzdHIobmV4dFN0YXJ0KSwgdGFyZ2V0LCByZXBsYWNlVGV4dClcbiAgKTtcbn1cbiJdLCJtYXBwaW5ncyI6IjtBQUFBLFdBQVc7O0FBQUNBLE1BQUEsQ0FBQUMsY0FBQSxDQUFBQyxPQUFBO0VBQUFDLEtBQUE7QUFBQTtBQUFBRCxPQUFBLENBQUFFLFlBQUEsR0FBQUEsWUFBQTtBQUFBRixPQUFBLENBQUFHLG1CQUFBLEdBQUFBLG1CQUFBO0FBQUFILE9BQUEsQ0FBQUksT0FBQSxHQUFBQSxPQUFBO0FBQUFKLE9BQUEsQ0FBQUssT0FBQSxHQUFBQSxPQUFBO0FBRUwsZUFBZUYsbUJBQW1CQSxDQUFDRyxJQUFJLEVBQUU7RUFDOUMsTUFBTUMsS0FBSyxHQUFHRCxJQUFJLENBQUNFLEtBQUssQ0FBQyxLQUFLLENBQUM7RUFDL0IsSUFBSUQsS0FBSyxDQUFDRSxNQUFNLElBQUksQ0FBQyxFQUFFO0lBQ3JCLE9BQU9ILElBQUk7RUFDYjs7RUFFQTtFQUNBLE1BQU1JLElBQUksR0FBR04sT0FBTyxDQUFDRyxLQUFLLENBQUM7O0VBRTNCO0VBQ0Es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